{% extends base_template %}
{% load static %}

{% block content %}
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          'lotus-gold': '#d1aa6b',
          'lotus-light': '#ffffff',
          'lotus-gray-light': '#f5f5f5',
          'lotus-border': '#e0e0e0',
        }
      }
    }
  }
</script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
*{font-family:'Roboto',sans-serif!important}

body{background:#f5f5f5;color:#222}

.full-contact-page{display:flex;justify-content:center;padding:40px 20px}
.lotus-container{max-width:1100px;width:100%;background:#fff;border-radius:14px;box-shadow:0 4px 30px rgba(0,0,0,.1)}

.page-title{font-size:1.6rem;font-weight:500;color:#d1aa6b}
.page-subtitle{font-size:.95rem;color:#666;margin-bottom:30px}

.property-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px}
.property-card{border:1px solid #eee;border-radius:12px;background:#fff}

.card-header{padding:16px;border-bottom:1px solid #eee;display:flex;justify-content:space-between}
.card-header p{margin:0;font-weight:500}

.property-info{padding:16px;background:#fafafa}
.info-item{display:flex;align-items:center;gap:10px;font-size:.85rem;color:#555;margin-bottom:10px}
.info-item svg{width:16px;height:16px;stroke:#d1aa6b}

.card-footer{padding:16px;display:flex;gap:12px}

.btn-email,.btn-text{
  flex:1;border:none;padding:12px;border-radius:8px;
  font-size:.9rem;font-weight:500;cursor:pointer;
  display:flex;align-items:center;justify-content:center;gap:8px
}
.btn-email{background:#d1aa6b;color:#000}
.btn-text{background:#1f2937;color:#fff}

.btn-email svg,.btn-text svg{width:16px;height:16px;stroke:currentColor}

.modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.45);
  display:none;align-items:center;justify-content:center;z-index:10000
}
.modal-content{
  background:#fff;width:90%;max-width:420px;border-radius:14px
}
.modal-content h3{
  padding:16px;border-bottom:1px solid #eee;font-size:16px;margin:0
}
.modal-content form{padding:20px}

.form-control{
  width:100%;padding:12px;border-radius:8px;
  border:1px solid #e0e0e0;margin-bottom:14px;box-sizing:border-box
}

.modal-buttons{display:flex;justify-content:flex-end;gap:10px}
.btn-secondary{background:#f0f0f0;border:none;padding:8px 14px;border-radius:8px;cursor:pointer}
.btn-primary{background:#d1aa6b;border:none;padding:8px 14px;border-radius:8px;cursor:pointer;color:#000;font-weight:500}
.btn-primary:disabled{background:#ccc;cursor:not-allowed}

.success-message{
  background:#10b981;color:#fff;padding:12px;border-radius:8px;margin-bottom:14px;display:none
}
.error-message{
  background:#ef4444;color:#fff;padding:12px;border-radius:8px;margin-bottom:14px;display:none
}

.loading-spinner{
  display:inline-block;width:14px;height:14px;border:2px solid #fff;
  border-top-color:transparent;border-radius:50%;animation:spin 0.6s linear infinite
}
@keyframes spin{to{transform:rotate(360deg)}}

.content-section{padding:40px}
</style>

<div class="bg-lotus-gray-light min-h-screen py-10 px-4">
  <div class="lotus-container max-w-4xl mx-auto bg-white rounded-lg overflow-hidden border border-lotus-border">
    
    <!-- Header -->
    <div class="py-6 px-6 sm:px-10 border-b border-lotus-border">
      <div class="flex flex-col sm:flex-row items-center justify-between">
        <div class="flex items-center gap-4 mb-4 sm:mb-0">
          <img class="w-16 sm:w-20" src="{% static 'img/smalllogo.png' %}" alt="Lotus Property Logo">
          <h1 class="text-2xl sm:text-3xl font-bold">Lotus Property</h1>
        </div>
        
      </div>
    </div>

    <!-- Main Content -->
    <div class="content-section">
      <h2 class="page-title">Contact your Client Manager</h2>
      <p class="page-subtitle">Send an email or text message.</p>

      <div class="property-grid">
      {% for property in properties %}
      {% ifchanged property.client_manager.id %}
      <div class="property-card">

        <div class="card-header">
          <p>{{ property.client_manager.first_name }} {{ property.client_manager.last_name }}</p>
        </div>

        <div class="property-info">
          <div class="info-item">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M4 4h16v16H4z" stroke-width="1.5"/>
              <path d="M4 4l8 8 8-8" stroke-width="1.5"/>
            </svg>
            {{ property.client_manager.email }}
          </div>

          <div class="info-item">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M5 4h4l2 5-2 2a16 16 0 008 8l2-2 5 2v4c0 1-1 2-2 2C10 25 1 16 3 6c0-1 1-2 2-2z" stroke-width="1.5"/>
            </svg>
            {{ property.client_manager.phone_number }}
          </div>
        </div>

        <div class="card-footer">
          <button class="btn-email" onclick="openEmail('{{ property.client_manager.email }}')">
            Email
          </button>

          <button class="btn-text" onclick="openText('{{ property.client_manager.phone_number }}')">
            Text
          </button>
        </div>

      </div>
      {% endifchanged %}
      {% endfor %}
      </div>
    </div>

  </div>
</div>

<!-- EMAIL MODAL -->
<div id="emailModal" class="modal-overlay">
<div class="modal-content">
<h3>Send Email</h3>
<div class="success-message" id="emailSuccess"></div>
<div class="error-message" id="emailError"></div>
<form id="emailForm">
{% csrf_token %}
<input type="hidden" id="recipientEmail" name="email">
<input type="text" name="subject" class="form-control" placeholder="Subject" required>
<textarea name="content" class="form-control" rows="4" placeholder="Email message..." required></textarea>
<div class="modal-buttons">
<button type="button" class="btn-secondary" onclick="closeModal('emailModal')">Cancel</button>
<button type="submit" class="btn-primary" id="emailSubmitBtn">Send</button>
</div>
</form>
</div>
</div>

<!-- TEXT MODAL -->
<div id="textModal" class="modal-overlay">
<div class="modal-content">
<h3>Send Text</h3>
<div class="success-message" id="textSuccess"></div>
<div class="error-message" id="textError"></div>
<form id="textForm">
{% csrf_token %}
<input type="hidden" id="recipientPhone" name="phone_number">
<textarea name="message" class="form-control" rows="4" placeholder="Text message..." required></textarea>
<div class="modal-buttons">
<button type="button" class="btn-secondary" onclick="closeModal('textModal')">Cancel</button>
<button type="submit" class="btn-primary" id="textSubmitBtn">Send</button>
</div>
</form>
</div>
</div>

<script>
function openEmail(email){
  console.log('Opening email modal for:', email);
  document.getElementById('recipientEmail').value = email;
  document.getElementById('emailModal').style.display='flex';
  document.getElementById('emailSuccess').style.display='none';
  document.getElementById('emailError').style.display='none';
  document.getElementById('emailForm').reset();
  document.getElementById('recipientEmail').value = email;
}

function openText(phone){
  console.log('Opening text modal for:', phone);
  document.getElementById('recipientPhone').value = phone;
  document.getElementById('textModal').style.display='flex';
  document.getElementById('textSuccess').style.display='none';
  document.getElementById('textError').style.display='none';
  document.getElementById('textForm').reset();
  document.getElementById('recipientPhone').value = phone;
}

function closeModal(id){
  document.getElementById(id).style.display='none';
  if(id === 'emailModal') {
    document.getElementById('emailForm').reset();
  } else if(id === 'textModal') {
    document.getElementById('textForm').reset();
  }
}

function showError(elementId, message) {
  console.error('Error:', message);
  const errorEl = document.getElementById(elementId);
  errorEl.textContent = message;
  errorEl.style.display = 'block';
}

function showSuccess(elementId, message) {
  console.log('Success:', message);
  const successEl = document.getElementById(elementId);
  successEl.textContent = message;
  successEl.style.display = 'block';
}

// Email Form Submit
document.getElementById('emailForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  console.log('Email form submitted');
  
  const submitBtn = document.getElementById('emailSubmitBtn');
  const originalText = submitBtn.innerHTML;
  
  // Disable button and show loading
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<span class="loading-spinner"></span> Sending...';
  
  // Hide previous messages
  document.getElementById('emailSuccess').style.display = 'none';
  document.getElementById('emailError').style.display = 'none';
  
  const formData = new FormData(this);
  const data = {
    email: formData.get('email'),
    subject: formData.get('subject'),
    content: formData.get('content')
  };
  
  console.log('Sending email data:', data);
  
  try {
    const response = await fetch('{% url "adminmanager:send_contact_email" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
      },
      body: JSON.stringify(data)
    });
    
    console.log('Response status:', response.status);
    
    const result = await response.json();
    console.log('Response data:', result);
    
    // Re-enable button
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalText;
    
    if(result.success) {
      showSuccess('emailSuccess', 'Email sent successfully!');
      setTimeout(() => {
        closeModal('emailModal');
      }, 2000);
    } else {
      showError('emailError', result.error || 'Failed to send email. Please try again.');
    }
  } catch(error) {
    console.error('Fetch error:', error);
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalText;
    showError('emailError', 'Network error: ' + error.message + '. Please check your connection and try again.');
  }
});

// Text Form Submit
document.getElementById('textForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  console.log('Text form submitted');
  
  const submitBtn = document.getElementById('textSubmitBtn');
  const originalText = submitBtn.innerHTML;
  
  // Disable button and show loading
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<span class="loading-spinner"></span> Sending...';
  
  // Hide previous messages
  document.getElementById('textSuccess').style.display = 'none';
  document.getElementById('textError').style.display = 'none';
  
  const formData = new FormData(this);
  const data = {
    phone_number: formData.get('phone_number'),
    message: formData.get('message')
  };
  
  console.log('Sending SMS data:', data);
  
  try {
    const response = await fetch('{% url "adminmanager:send_sms" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
      },
      body: JSON.stringify(data)
    });
    
    console.log('Response status:', response.status);
    
    const result = await response.json();
    console.log('Response data:', result);
    
    // Re-enable button
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalText;
    
    if(result.success) {
      showSuccess('textSuccess', result.message || 'SMS sent successfully!');
      setTimeout(() => {
        closeModal('textModal');
      }, 2000);
    } else {
      showError('textError', result.error || 'Failed to send SMS. Please try again.');
    }
  } catch(error) {
    console.error('Fetch error:', error);
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalText;
    showError('textError', 'Network error: ' + error.message + '. Please check your connection and try again.');
  }
});

// Close modal when clicking outside
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', function(e) {
    if(e.target === this) {
      closeModal(this.id);
    }
  });
});
</script>

{% endblock content %}